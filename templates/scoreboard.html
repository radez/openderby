<html>
<head>
  <script type='application/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js'></script>
  <script type='application/javascript'>
    $(document).ready(function() {

      websocket = '{{ scheme }}://{{ host }}:{{ port}}/ws';
      if (window.WebSocket) {
        ws = new WebSocket(websocket);
      }
      else if (window.MozWebSocket) {
        ws = MozWebSocket(websocket);
      }
      else {
        console.log('WebSocket Not Supported');
        return;
      }

      window.onbeforeunload = function(e) {
        $('#chat').val($('#chat').val() + 'Bye bye...\n');
        ws.close(1000, '{{ username }} left the room');

        if(!e) e = window.event;
        e.stopPropagation();
        e.preventDefault();
      };
      ws.onmessage = function (evt) {
         try{
           var msg = JSON.parse(evt.data);
           $('#' + msg.element).text(msg.val);
         } finally {
           $('#chat').val($('#chat').val() + 'test: ' + evt.data + '\n');
         }
      };
      ws.onopen = function() {
         ws.send("{{ username }} entered the room");
      };
      ws.onclose = function(evt) {
         $('#chat').val('Connection closed by server: ' + evt.code + ' \"' + evt.reason + '\"\n');
         ws = null;
         while(! ws) {
             $('#chat').val($('#chat').val() + 'Reconnecting...');
             if (window.WebSocket) {
                 ws = new WebSocket(websocket);
             }
             else if (window.MozWebSocket) {
                 ws = MozWebSocket(websocket);
             }
             else {
                console.log('WebSocket Not Supported');
                return;
             }
             sleep(5);
         }
      };

      $('#send').click(function() {
         console.log($('#message').val());
         ws.send('{{ username }}: ' + $('#message').val());
         $('#message').val("");
         return false;
      });
    });
  </script>
  <style>
.left { float:left; }
.right { float:right; }
.flex { flex:1; }
.border { border:1px solid black; }
#header { font-size:5em; }
#lanes { font-size:7em;
         clear:both;
         width:100%;}
body {padding:2em;}
  </style>
</head>
<body>
<div id="header">
    <div class="left"><div id='category' class="right">No Race Loaded</div></div>
    <div class="right"><div class="left">Heat: </div><div id='heat' class="right">0</div></div>
</div>
<div id="lanes">
        <div class="left">1:</div>
        <div id='lane1name' class="left">&nbsp;</div>
        <div id='lane1time' class="right">&nbsp;</div>
</div>
<div id="lanes">
        <div class="left">2:</div>
        <div id='lane2name' class="left">&nbsp;</div>
        <div id='lane2time' class="right">&nbsp;</div>
</div>
<div id="lanes">
        <div class="left">3:</div>
        <div id='lane3name' class="left">&nbsp;</div>
        <div id='lane3time' class="right">&nbsp;</div>
</div>
<div id="lanes">
        <div class="left">4:</div>
        <div id='lane4name' class="left">&nbsp;</div>
        <div id='lane4time' class="right">&nbsp;</div>
</div>
<div id="lanes">
        <div class="left">5:</div>
        <div id='lane5name' class="left">&nbsp;</div>
        <div id='lane5time' class="right">&nbsp;</div>
</div>
<div id="lanes">
        <div class="left">6:</div>
        <div id='lane6name' class="left">&nbsp;</div>
        <div id='lane6time' class="right">&nbsp;</div>
</div>

<div style="clear:both;" />
<form action='#' id='chatform' method='get'>
  <textarea id='chat' cols='35' rows='10'></textarea>
  <br />
  <label for='message'>{{ username }}: </label><input type='text' id='message' />
  <input id='send' type='submit' value='Send' />
  </form>
</body>
</html>
